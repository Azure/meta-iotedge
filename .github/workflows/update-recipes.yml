name: Update Yocto recipes

on:
  workflow_dispatch:
    inputs:
      iotedge_sha:
        description: "IoT Edge git SHA (Azure/iotedge)"
        required: false
      iotedge_version:
        description: "IoT Edge version (e.g., 1.5.21)"
        required: false
      iis_sha:
        description: "IoT Identity Service git SHA (Azure/iot-identity-service)"
        required: false
      iis_version:
        description: "IoT Identity Service version (e.g., 1.5.21)"
        required: false
      overwrite:
        description: "Overwrite existing recipe files"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-recipes:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    container:
      image: ghcr.io/${{ github.repository_owner }}/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update recipes
        env:
          IOTEDGE_SHA: ${{ inputs.iotedge_sha }}
          IOTEDGE_VERSION: ${{ inputs.iotedge_version }}
          IIS_SHA: ${{ inputs.iis_sha }}
          IIS_VERSION: ${{ inputs.iis_version }}
          OVERWRITE: ${{ inputs.overwrite }}
        run: |
          set -euo pipefail
          args=()
          if [[ -n "${IOTEDGE_SHA}" ]]; then
            if [[ -z "${IOTEDGE_VERSION}" ]]; then
              echo "iotedge_version is required when iotedge_sha is provided"
              exit 1
            fi
            args+=(--iotedge-rev "${IOTEDGE_SHA}" --iotedge-version "${IOTEDGE_VERSION}")
          fi
          if [[ -n "${IIS_SHA}" ]]; then
            if [[ -z "${IIS_VERSION}" ]]; then
              echo "iis_version is required when iis_sha is provided"
              exit 1
            fi
            args+=(--iis-rev "${IIS_SHA}" --iis-version "${IIS_VERSION}")
          fi
          if [[ "${OVERWRITE}" == "true" ]]; then
            args+=(--overwrite)
          fi
          ./scripts/update-recipes.sh "${args[@]}"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Update Yocto recipes"
          commit-message: "Update Yocto recipes"
          branch: automation/update-recipes
          delete-branch: true
          body: |
            Automated recipe update.

            Inputs:
            - IoT Edge: ${{ inputs.iotedge_version }} @ ${{ inputs.iotedge_sha }}
            - IoT Identity Service: ${{ inputs.iis_version }} @ ${{ inputs.iis_sha }}
