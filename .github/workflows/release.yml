name: Release

on:
  push:
    tags:
      - "1.5.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., 1.5.35)"
        required: true

permissions:
  contents: write
  packages: read

jobs:
  # Call the CI workflow to build and validate
  build:
    name: Build and validate
    uses: ./.github/workflows/ci-build.yml
    with:
      ref: ${{ inputs.tag || github.ref_name }}
      skip_qemu: false
    secrets: inherit

  # Create release after successful build and validation
  release:
    name: Create release
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Download RPM packages
        uses: actions/download-artifact@v4
        with:
          name: rpm-packages-scarthgap
          path: release-artifacts/rpm

      - name: Download QEMU image
        uses: actions/download-artifact@v4
        with:
          name: iotedge-qemu-image-scarthgap
          path: release-artifacts/qemu

      - name: Prepare release artifacts
        id: artifacts
        run: |
          mkdir -p final-artifacts rpm-staging
          VERSION="${{ inputs.tag || github.ref_name }}"
          
          # Only include IoT Edge specific RPMs (not all dependencies)
          find release-artifacts/rpm -type f -name "*.rpm" \( \
            -name "iotedge-*.rpm" -o \
            -name "aziot-*.rpm" \) \
            -exec cp {} rpm-staging/ \;
          
          echo "IoT Edge RPMs to include:"
          ls -la rpm-staging/
          
          # Create tarball of just the IoT Edge packages
          tar -czvf "final-artifacts/iotedge-rpms-${VERSION}.tar.gz" -C rpm-staging .
          
          # Compress QEMU rootfs
          if [[ -f release-artifacts/qemu/iotedge-qemu-image-qemux86-64.rootfs.ext4 ]]; then
            zstd -T0 -19 release-artifacts/qemu/iotedge-qemu-image-qemux86-64.rootfs.ext4 \
              -o final-artifacts/iotedge-qemu-image-qemux86-64.rootfs.ext4.zst
          fi
          
          # Copy kernel
          cp release-artifacts/qemu/bzImage final-artifacts/ 2>/dev/null || true
          
          echo "Release artifacts:"
          ls -la final-artifacts/
          
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: actions/github-script@v7
        env:
          TAG_NAME: ${{ inputs.tag || github.ref_name }}
          VERSION: ${{ steps.artifacts.outputs.version }}
          REPO: ${{ github.repository }}
          REF_NAME: ${{ github.ref_name }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const tagName = process.env.TAG_NAME;
            const version = process.env.VERSION;
            const repo = process.env.REPO;
            const refName = process.env.REF_NAME;
            const isPrerelease = refName.includes('-rc') || refName.includes('-beta');

            const body = `## Azure IoT Edge Yocto Layer Release

            This release provides Yocto/OpenEmbedded recipes for building Azure IoT Edge on embedded Linux systems.

            ### For Yocto Users

            **Most users should build from source using the recipes in this repository.** The pre-built RPMs below are for the \`qemux86-64\` target and won't work on other hardware. To build for your target:

            \`\`\`bash
            git clone --branch ${version} https://github.com/${repo}.git
            cd meta-iotedge
            ./scripts/build.sh scarthgap
            \`\`\`

            ### Pre-built Artifacts (qemux86-64 only)

            These artifacts are primarily for CI verification and testing:

            **RPM Packages** — Built for \`qemux86-64\`, useful for reference:
            \`\`\`bash
            tar -xzvf iotedge-rpms-${version}.tar.gz
            \`\`\`

            Included: iotedge, aziot-edged, aziotd, aziotctl, aziot-keys

            **QEMU Test Image** — Complete bootable image with IoT Edge pre-installed:
            \`\`\`bash
            zstd -d iotedge-qemu-image-qemux86-64.rootfs.ext4.zst

            qemu-system-x86_64 \\
              -kernel bzImage \\
              -drive file=iotedge-qemu-image-qemux86-64.rootfs.ext4,format=raw \\
              -append "root=/dev/sda console=ttyS0" \\
              -nographic -m 512
            \`\`\`

            ### Documentation
            See the [README](https://github.com/${repo}#readme) for detailed build and integration instructions.`.replace(/^            /gm, '');

            // Create the release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `IoT Edge Yocto Layer ${version}`,
              body: body,
              draft: false,
              prerelease: isPrerelease,
              generate_release_notes: true
            });

            core.info(`Created release ${release.html_url}`);

            // Upload assets from final-artifacts/
            const artifactsDir = 'final-artifacts';
            const files = fs.readdirSync(artifactsDir);
            for (const file of files) {
              const filePath = path.join(artifactsDir, file);
              const stat = fs.statSync(filePath);
              if (!stat.isFile()) continue;

              core.info(`Uploading ${file} (${stat.size} bytes)`);
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                name: file,
                data: fs.readFileSync(filePath)
              });
            }
