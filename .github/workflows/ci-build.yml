name: Yocto build

on:
  pull_request:
    branches:
      - main
      - kirkstone
  push:
    branches:
      - main
      - kirkstone
  workflow_dispatch:
    inputs:
      skip_qemu:
        description: "Skip QEMU validation (faster, packages only)"
        type: boolean
        default: false
  workflow_call:
    inputs:
      ref:
        description: "Git ref to checkout (tag or branch)"
        type: string
        required: false
      skip_qemu:
        description: "Skip QEMU validation"
        type: boolean
        default: false
    outputs:
      template:
        description: "Template used for build"
        value: ${{ jobs.check-changes.outputs.template }}

permissions:
  contents: read
  packages: read

concurrency:
  group: yocto-build-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  check-changes:
    name: Check if only docs changed
    runs-on: ubuntu-22.04
    outputs:
      docs_only: ${{ steps.docs-only.outputs.docs_only }}
      template: ${{ steps.set-template.outputs.template }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || '' }}
          fetch-depth: 0

      - name: Check if only docs changed
        id: docs-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check files changed in the PR
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For pushes, check files in the last commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --diff-filter=A HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if all changed files are documentation-related
          DOCS_ONLY=true
          if [ -z "$CHANGED_FILES" ]; then
            echo "No files changed"
            DOCS_ONLY=false
          else
            while IFS= read -r file; do
              # Skip empty lines
              [ -z "$file" ] && continue
              if [[ ! "$file" =~ \.(md|MD)$ ]] && \
                 [[ ! "$file" =~ ^docs/ ]] && \
                 [[ "$file" != "LICENSE" ]] && \
                 [[ "$file" != "SECURITY.md" ]] && \
                 [[ "$file" != "THIRDPARTYNOTICES" ]]; then
                DOCS_ONLY=false
                break
              fi
            done <<< "$CHANGED_FILES"
          fi
          
          echo "docs_only=$DOCS_ONLY" >> "$GITHUB_OUTPUT"
          if [ "$DOCS_ONLY" = "true" ]; then
            echo "Only documentation files changed - skipping build"
          else
            echo "Code files changed - running full build"
          fi

      - name: Determine template from branch
        id: set-template
        run: |
          case "${{ github.base_ref || github.ref_name }}" in
            kirkstone) echo "template=kirkstone" >> "$GITHUB_OUTPUT" ;;  
            *) echo "template=scarthgap" >> "$GITHUB_OUTPUT" ;;  
          esac

  check-recipes:
    name: Recipe consistency check
    needs: check-changes
    if: needs.check-changes.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || '' }}

      - name: Extract IoT Edge version from committed recipes
        id: version
        run: |
          bb_file=$(ls recipes-core/iotedge/iotedge_*.bb 2>/dev/null | head -1)
          if [[ -z "${bb_file}" ]]; then
            echo "No iotedge recipe found — skipping idempotency check"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          ver=$(basename "${bb_file}" | sed 's/^iotedge_//;s/\.bb$//')
          echo "iotedge_version=${ver}" >> "$GITHUB_OUTPUT"
          echo "Detected IoT Edge version: ${ver}"

      - name: Regenerate recipes
        if: ${{ steps.version.outputs.skip != 'true' }}
        run: |
          ./scripts/update-recipes.sh \
            --iotedge-version "${{ steps.version.outputs.iotedge_version }}" \
            --skip-validate

      - name: Check for drift between generated and committed recipes
        if: ${{ steps.version.outputs.skip != 'true' }}
        run: |
          if ! git diff --exit-code recipes-core/; then
            echo ""
            echo "::error::Generated recipes differ from committed files."
            echo "Run './scripts/update-recipes.sh --iotedge-version ${{ steps.version.outputs.iotedge_version }}' and commit the results."
            exit 1
          fi
          echo "✓ Committed recipes match generated output"

  build:
    name: Build and validate
    needs: [check-changes, check-recipes]
    if: needs.check-changes.outputs.docs_only != 'true'
    runs-on:
    - self-hosted
    - 1ES.Pool=meta-iotedge-1es-github-linux-amd64
    - 1ES.ImageOverride=agent-aziotedge-ubuntu-22.04-msmoby
    outputs:
      template: ${{ needs.check-changes.outputs.template }}
    container:
      image: ghcr.io/azure/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root -v ${{ vars.YOCTO_CACHE_PATH || '/var/cache/yocto' }}:/workspaces/yocto-cache
    env:
      DEVCONTAINER: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || '' }}

      - name: Configure git safe directory
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Create build user
        run: |
          useradd -m builder
          chown -R builder:builder /workspaces/yocto-cache

      - name: Fix permissions
        run: chown -R builder:builder "${GITHUB_WORKSPACE}"

      - name: Show cache status
        run: |
          echo "Sstate cache: $(du -sh /workspaces/yocto-cache/sstate-cache 2>/dev/null | cut -f1 || echo 'empty')"
          echo "Downloads: $(du -sh /workspaces/yocto-cache/downloads 2>/dev/null | cut -f1 || echo 'empty')"

      - name: Fetch layers
        run: sudo -E -u builder ./scripts/fetch.sh "${{ needs.check-changes.outputs.template }}"

      - name: Build
        env:
          TEMPLATE: ${{ needs.check-changes.outputs.template }}
        run: |
          if [[ "${{ inputs.skip_qemu }}" == "true" ]]; then
            sudo -E -u builder ./scripts/build.sh "${TEMPLATE}"
          else
            sudo -E -u builder ./scripts/build.sh "${TEMPLATE}" --with-qemu
          fi

      - name: Run QEMU validation
        if: ${{ !inputs.skip_qemu }}
        run: sudo -E -u builder ./scripts/validate-qemu.sh "${{ needs.check-changes.outputs.template }}"

      - name: Collect IoT Edge RPM packages
        id: collect-rpms
        run: |
          mkdir -p rpm-staging
          find build/tmp/deploy/rpm -type f -name "*.rpm" \( \
            -name "iotedge-*.rpm" -o \
            -name "aziot-*.rpm" \) \
            -exec cp {} rpm-staging/ \;
          echo "IoT Edge RPMs:"
          ls -la rpm-staging/

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ needs.check-changes.outputs.template }}
          path: rpm-staging/*.rpm
          retention-days: 7
          if-no-files-found: warn

      - name: Upload QEMU image
        if: ${{ !inputs.skip_qemu }}
        uses: actions/upload-artifact@v4
        with:
          name: iotedge-qemu-image-${{ needs.check-changes.outputs.template }}
          path: |
            build/tmp/deploy/images/qemux86-64/iotedge-qemu-image-qemux86-64.rootfs.ext4
            build/tmp/deploy/images/qemux86-64/bzImage
          retention-days: 7
          if-no-files-found: warn

  status-check:
    name: Status check
    runs-on: ubuntu-22.04
    needs: [check-changes, check-recipes, build]
    if: always()
    steps:
      - name: Determine overall status
        run: |
          if [ "${{ needs.check-changes.outputs.docs_only }}" == "true" ]; then
            echo "✓ Docs-only change - no build required"
            exit 0
          elif [ "${{ needs.check-recipes.result }}" != "success" ]; then
            echo "✗ Recipe consistency check failed"
            exit 1
          elif [ "${{ needs.build.result }}" == "success" ]; then
            echo "✓ Build succeeded"
            exit 0
          else
            echo "✗ Build failed or was cancelled"
            exit 1
          fi
