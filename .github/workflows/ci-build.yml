name: Yocto build (self-hosted)

on:
  pull_request:
    branches:
      - main
      - kirkstone
  push:
    branches:
      - main
      - kirkstone
  workflow_dispatch:
    inputs:
      skip_qemu:
        description: "Skip QEMU validation (faster, packages only)"
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: yocto-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build and validate
    runs-on: self-hosted
    steps:
      - name: Determine template from branch
        id: set-template
        run: |
          case "${{ github.base_ref || github.ref_name }}" in
            kirkstone) echo "template=kirkstone" >> "$GITHUB_OUTPUT" ;;  
            *) echo "template=scarthgap" >> "$GITHUB_OUTPUT" ;;  
          esac

      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify cache setup
        run: |
          # Symlink should already exist: /workspaces/yocto-cache -> ~/yocto-cache
          echo "Checking /workspaces..."
          ls -la /workspaces/ || echo "/workspaces does not exist"
          echo "Checking symlink target..."
          ls -la /workspaces/yocto-cache/ || echo "symlink broken"
          echo "Testing write..."
          touch /workspaces/yocto-cache/sstate-cache/.write-test && rm /workspaces/yocto-cache/sstate-cache/.write-test
          echo "Write test passed"
          if [[ ! -L /workspaces/yocto-cache ]]; then
            echo "ERROR: /workspaces/yocto-cache symlink not found!"
            echo "Run this once on the runner: sudo mkdir -p /workspaces && sudo ln -sf ~/yocto-cache /workspaces/yocto-cache"
            exit 1
          fi
          mkdir -p "${HOME}/yocto-cache/sstate-cache" "${HOME}/yocto-cache/downloads"
          echo "Sstate cache size: $(du -sh ${HOME}/yocto-cache/sstate-cache 2>/dev/null | cut -f1 || echo 'empty')"
          echo "Downloads size: $(du -sh ${HOME}/yocto-cache/downloads 2>/dev/null | cut -f1 || echo 'empty')"

      - name: Fetch layers
        run: ./scripts/fetch.sh "${{ steps.set-template.outputs.template }}"

      - name: Build
        env:
          TEMPLATE: ${{ steps.set-template.outputs.template }}
        run: |
          if [[ "${{ inputs.skip_qemu }}" == "true" ]]; then
            ./scripts/build.sh "${TEMPLATE}"
          else
            ./scripts/build.sh "${TEMPLATE}" --with-qemu
          fi

      - name: Run QEMU validation
        if: ${{ !inputs.skip_qemu }}
        run: ./scripts/validate-qemu.sh "${{ steps.set-template.outputs.template }}"

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ steps.set-template.outputs.template }}
          path: build/tmp/deploy/rpm/**/*.rpm
          retention-days: 7
          if-no-files-found: warn

      - name: Upload QEMU image
        if: ${{ !inputs.skip_qemu }}
        uses: actions/upload-artifact@v4
        with:
          name: iotedge-qemu-image-${{ steps.set-template.outputs.template }}
          path: |
            build/tmp/deploy/images/qemux86-64/iotedge-qemu-image-qemux86-64.rootfs.ext4
            build/tmp/deploy/images/qemux86-64/bzImage
          retention-days: 7
          if-no-files-found: warn

      - name: Cleanup workspace
        if: always()
        run: |
          # Keep cache, clean build artifacts to save disk space
          rm -rf build/tmp/work build/tmp/stamps
