name: Yocto build

on:
  pull_request:
    branches:
      - main
      - kirkstone
  push:
    branches:
      - main
      - kirkstone
  workflow_dispatch:
    inputs:
      skip_qemu:
        description: "Skip QEMU validation (faster, packages only)"
        type: boolean
        default: false
  workflow_call:
    inputs:
      ref:
        description: "Git ref to checkout (tag or branch)"
        type: string
        required: false
      skip_qemu:
        description: "Skip QEMU validation"
        type: boolean
        default: false
    outputs:
      template:
        description: "Template used for build"
        value: ${{ jobs.build.outputs.template }}

permissions:
  contents: read
  packages: read

concurrency:
  group: yocto-build-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build:
    name: Build and validate
    runs-on:
    - self-hosted
    - 1ES.Pool=meta-iotedge-1es-github-linux-amd64
    - 1ES.ImageOverride=agent-aziotedge-ubuntu-22.04-msmoby
    outputs:
      template: ${{ steps.set-template.outputs.template }}
    container:
      image: ghcr.io/azure/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root -v ${{ vars.YOCTO_CACHE_PATH || '/var/cache/yocto' }}:/workspaces/yocto-cache
    env:
      DEVCONTAINER: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || '' }}
          fetch-depth: 0

      - name: Check if only docs changed
        id: docs-only
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, check files changed in the PR
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For pushes, check files in the last commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if all changed files are documentation-related
          DOCS_ONLY=true
          while IFS= read -r file; do
            if [[ ! "$file" =~ \.(md|MD)$ ]] && \
               [[ ! "$file" =~ ^docs/ ]] && \
               [[ "$file" != "LICENSE" ]] && \
               [[ "$file" != "SECURITY.md" ]] && \
               [[ "$file" != "THIRDPARTYNOTICES" ]]; then
              DOCS_ONLY=false
              break
            fi
          done <<< "$CHANGED_FILES"
          
          echo "docs_only=$DOCS_ONLY" >> "$GITHUB_OUTPUT"
          if [ "$DOCS_ONLY" = "true" ]; then
            echo "Only documentation files changed - skipping build"
          else
            echo "Code files changed - running full build"
          fi

      - name: Determine template from branch
        id: set-template
        run: |
          case "${{ github.base_ref || github.ref_name }}" in
            kirkstone) echo "template=kirkstone" >> "$GITHUB_OUTPUT" ;;  
            *) echo "template=scarthgap" >> "$GITHUB_OUTPUT" ;;  
          esac

      - name: Create build user
        if: steps.docs-only.outputs.docs_only != 'true'
        run: |
          useradd -m builder
          chown -R builder:builder /workspaces/yocto-cache

      - name: Fix permissions
        if: steps.docs-only.outputs.docs_only != 'true'
        run: |
          chown -R builder:builder "${GITHUB_WORKSPACE}"
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Show cache status
        if: steps.docs-only.outputs.docs_only != 'true'
        run: |
          echo "Sstate cache: $(du -sh /workspaces/yocto-cache/sstate-cache 2>/dev/null | cut -f1 || echo 'empty')"
          echo "Downloads: $(du -sh /workspaces/yocto-cache/downloads 2>/dev/null | cut -f1 || echo 'empty')"

      - name: Fetch layers
        if: steps.docs-only.outputs.docs_only != 'true'
        run: sudo -E -u builder ./scripts/fetch.sh "${{ steps.set-template.outputs.template }}"

      - name: Build
        if: steps.docs-only.outputs.docs_only != 'true'
        env:
          TEMPLATE: ${{ steps.set-template.outputs.template }}
        run: |
          if [[ "${{ inputs.skip_qemu }}" == "true" ]]; then
            sudo -E -u builder ./scripts/build.sh "${TEMPLATE}"
          else
            sudo -E -u builder ./scripts/build.sh "${TEMPLATE}" --with-qemu
          fi

      - name: Run QEMU validation
        if: ${{ !inputs.skip_qemu && steps.docs-only.outputs.docs_only != 'true' }}
        run: sudo -E -u builder ./scripts/validate-qemu.sh "${{ steps.set-template.outputs.template }}"

      - name: Collect IoT Edge RPM packages
        if: steps.docs-only.outputs.docs_only != 'true'
        id: collect-rpms
        run: |
          mkdir -p rpm-staging
          find build/tmp/deploy/rpm -type f -name "*.rpm" \( \
            -name "iotedge-*.rpm" -o \
            -name "aziot-*.rpm" \) \
            -exec cp {} rpm-staging/ \;
          echo "IoT Edge RPMs:"
          ls -la rpm-staging/

      - name: Upload RPM packages
        if: steps.docs-only.outputs.docs_only != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ steps.set-template.outputs.template }}
          path: rpm-staging/*.rpm
          retention-days: 7
          if-no-files-found: warn

      - name: Upload QEMU image
        if: ${{ !inputs.skip_qemu && steps.docs-only.outputs.docs_only != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: iotedge-qemu-image-${{ steps.set-template.outputs.template }}
          path: |
            build/tmp/deploy/images/qemux86-64/iotedge-qemu-image-qemux86-64.rootfs.ext4
            build/tmp/deploy/images/qemux86-64/bzImage
          retention-days: 7
          if-no-files-found: warn
