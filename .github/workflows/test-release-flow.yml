name: Test release flow

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "What to test"
        type: choice
        options:
          - "upstream-detection"
          - "recipe-update"
          - "release-dry-run"
        default: "upstream-detection"
      fake_iotedge_version:
        description: "Fake IoT Edge version to simulate (e.g., 1.5.99)"
        required: false
      fake_iis_version:
        description: "Fake IIS version to simulate (e.g., 1.5.99)"
        required: false

permissions:
  contents: read

jobs:
  test-upstream-detection:
    name: Test upstream detection
    if: inputs.test_type == 'upstream-detection'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check upstream releases
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read current versions from release.md
            const releaseDoc = fs.readFileSync('docs/release.md', 'utf8');
            const currentIotedge = releaseDoc.match(/IoT Edge \| (\d+\.\d+\.\d+)/)?.[1];
            const currentIis = releaseDoc.match(/IoT Identity Service \| (\d+\.\d+\.\d+)/)?.[1];
            
            console.log(`ğŸ“‹ Current versions in release.md:`);
            console.log(`   IoT Edge: ${currentIotedge}`);
            console.log(`   IoT Identity Service: ${currentIis}`);
            console.log('');
            
            // Get latest IoT Edge release
            const iotedgeReleases = await github.rest.repos.listReleases({
              owner: 'Azure',
              repo: 'iotedge',
              per_page: 5
            });
            
            console.log(`ğŸ” Recent IoT Edge releases:`);
            for (const r of iotedgeReleases.data.slice(0, 5)) {
              const status = r.tag_name === currentIotedge ? 'âœ… (current)' : 
                            r.prerelease ? 'â­ï¸ (prerelease)' : 'ğŸ†• (newer)';
              console.log(`   ${r.tag_name} ${status}`);
            }
            console.log('');
            
            // Get latest IIS release
            const iisReleases = await github.rest.repos.listReleases({
              owner: 'Azure',
              repo: 'iot-identity-service',
              per_page: 5
            });
            
            console.log(`ğŸ” Recent IoT Identity Service releases:`);
            for (const r of iisReleases.data.slice(0, 5)) {
              const status = r.tag_name === currentIis ? 'âœ… (current)' : 
                            r.prerelease ? 'â­ï¸ (prerelease)' : 'ğŸ†• (newer)';
              console.log(`   ${r.tag_name} ${status}`);
            }
            console.log('');
            
            // Check what would happen
            const latestIotedge = iotedgeReleases.data.find(r => 
              !r.prerelease && !r.draft && r.tag_name.match(/^1\.5\.\d+$/)
            );
            const latestIis = iisReleases.data.find(r => 
              !r.prerelease && !r.draft && r.tag_name.match(/^1\.5\.\d+$/)
            );
            
            console.log(`ğŸ“Š Analysis:`);
            if (latestIotedge?.tag_name !== currentIotedge) {
              console.log(`   âš ï¸ IoT Edge update available: ${currentIotedge} â†’ ${latestIotedge?.tag_name}`);
              
              // Check if significant
              const body = latestIotedge?.body || '';
              const hasEdgeletChanges = body.toLowerCase().includes('edgelet') ||
                                        body.toLowerCase().includes('aziot-edged');
              console.log(`   ${hasEdgeletChanges ? 'ğŸ”§ Contains daemon changes - PR would be created' : 'ğŸ³ Docker-only - issue would be created'}`);
            } else {
              console.log(`   âœ… IoT Edge is up to date`);
            }
            
            if (latestIis?.tag_name !== currentIis) {
              console.log(`   âš ï¸ IIS update available: ${currentIis} â†’ ${latestIis?.tag_name}`);
              console.log(`   ğŸ”§ IIS updates always create PR`);
            } else {
              console.log(`   âœ… IoT Identity Service is up to date`);
            }

  test-recipe-update:
    name: Test recipe update (dry run)
    if: inputs.test_type == 'recipe-update'
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/${{ github.repository_owner }}/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test recipe update (dry run)
        run: |
          echo "ğŸ§ª Testing recipe update script..."
          echo ""
          echo "This would run:"
          echo "  ./scripts/update-recipes.sh \\"
          if [[ -n "${{ inputs.fake_iotedge_version }}" ]]; then
            echo "    --iotedge-rev <sha> --iotedge-version ${{ inputs.fake_iotedge_version }} \\"
          fi
          if [[ -n "${{ inputs.fake_iis_version }}" ]]; then
            echo "    --iis-rev <sha> --iis-version ${{ inputs.fake_iis_version }}"
          fi
          echo ""
          echo "Current recipe files:"
          ls -la recipes-core/*/

  test-release-dry-run:
    name: Test release (dry run)
    if: inputs.test_type == 'release-dry-run'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Simulate release
        run: |
          echo "ğŸ§ª Testing release workflow..."
          echo ""
          echo "If you pushed a tag, release.yml would:"
          echo "  1. Build all packages with ./scripts/build.sh"
          echo "  2. Build QEMU image with ./scripts/bitbake.sh iotedge-qemu-image"
          echo "  3. Collect artifacts:"
          echo "     - RPM packages from build/tmp/deploy/rpm/"
          echo "     - QEMU image (compressed with zstd)"
          echo "     - Linux kernel (bzImage)"
          echo "  4. Create GitHub Release with all artifacts"
          echo ""
          echo "To test for real:"
          echo "  git tag v1.5.34-test"
          echo "  git push origin v1.5.34-test"
          echo ""
          echo "Then delete the test tag/release after:"
          echo "  git tag -d v1.5.34-test"
          echo "  git push origin :refs/tags/v1.5.34-test"
