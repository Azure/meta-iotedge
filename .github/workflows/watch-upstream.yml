name: Watch upstream releases

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    name: Check for new releases
    runs-on: ubuntu-22.04
    outputs:
      release_version: ${{ steps.check.outputs.release_version }}  # Latest overall release (e.g., 1.5.35)
      iotedge_update: ${{ steps.check.outputs.iotedge_update }}
      iotedge_version: ${{ steps.check.outputs.iotedge_version }}  # Daemon version (e.g., 1.5.21)
      iotedge_sha: ${{ steps.check.outputs.iotedge_sha }}
      iis_update: ${{ steps.check.outputs.iis_update }}
      iis_version: ${{ steps.check.outputs.iis_version }}
      iis_sha: ${{ steps.check.outputs.iis_sha }}
      latest_iis_version: ${{ steps.check.outputs.latest_iis_version }}
      needs_update: ${{ steps.check.outputs.needs_update }}
      is_significant: ${{ steps.check.outputs.is_significant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check upstream releases
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Detect current versions from recipe files
            function getRecipeVersion(recipeDir, prefix) {
              try {
                const files = fs.readdirSync(recipeDir).filter(f => f.startsWith(prefix + '_') && f.endsWith('.bb'));
                if (files.length === 0) return null;
                const versions = files.map(f => f.replace(prefix + '_', '').replace('.bb', ''));
                versions.sort((a, b) => {
                  const [aMaj, aMin, aPatch] = a.split('.').map(Number);
                  const [bMaj, bMin, bPatch] = b.split('.').map(Number);
                  return (bMaj - aMaj) || (bMin - aMin) || (bPatch - aPatch);
                });
                return versions[0];
              } catch { return null; }
            }
            
            const currentIotedge = getRecipeVersion('recipes-core/iotedge', 'iotedge');
            const currentIis = getRecipeVersion('recipes-core/aziotd', 'aziotd');
            
            console.log(`ðŸ“‹ Current versions from recipes:`);
            console.log(`   IoT Edge: ${currentIotedge || 'not found'}`);
            console.log(`   IoT Identity Service: ${currentIis || 'not found'}`);
            
            // Use Azure/azure-iotedge as the canonical source (combined releases)
            // This tells us which IIS version goes with each Edge release
            const releases = await github.rest.repos.listReleases({
              owner: 'Azure',
              repo: 'azure-iotedge',
              per_page: 10
            });
            
            // Find latest stable 1.5.x release
            const latestRelease = releases.data.find(r => 
              !r.prerelease && !r.draft && r.tag_name.match(/^1\.5\.\d+$/)
            );
            
            if (!latestRelease) {
              console.log('No stable 1.5.x release found');
              core.setOutput('needs_update', false);
              return;
            }
            
            const releaseVersion = latestRelease.tag_name;
            console.log(`ðŸ” Latest release: ${releaseVersion}`);
            
            // Extract IIS version from release assets
            const iisAsset = latestRelease.assets.find(a => a.name.match(/^aziot-identity-service-[\d.]+-.*\.rpm$/));
            const iisVersion = iisAsset ? iisAsset.name.match(/aziot-identity-service-([\d.]+)-/)?.[1] : null;
            
            console.log(`   IoT Edge: ${releaseVersion}`);
            console.log(`   IIS (from assets): ${iisVersion}`);
            
            // Output versions for release notes
            core.setOutput('release_version', releaseVersion);
            core.setOutput('latest_iis_version', iisVersion || currentIis);
            
            // Check if we need to update
            let needsUpdate = false;
            let iotedgeUpdate = false;
            let iisUpdate = false;
            
            if (releaseVersion !== currentIotedge) {
              iotedgeUpdate = true;
              needsUpdate = true;
              console.log(`   âš ï¸ IoT Edge update needed: ${currentIotedge} â†’ ${releaseVersion}`);
              
              // Get SHA from Azure/iotedge repo (has tags for all releases)
              const tagRef = await github.rest.git.getRef({
                owner: 'Azure', repo: 'iotedge',
                ref: `tags/${releaseVersion}`
              });
              core.setOutput('iotedge_version', releaseVersion);
              core.setOutput('iotedge_sha', tagRef.data.object.sha);
            }
            
            if (iisVersion && iisVersion !== currentIis) {
              iisUpdate = true;
              needsUpdate = true;
              console.log(`   âš ï¸ IIS update needed: ${currentIis} â†’ ${iisVersion}`);
              
              const tagRef = await github.rest.git.getRef({
                owner: 'Azure', repo: 'iot-identity-service',
                ref: `tags/${iisVersion}`
              });
              core.setOutput('iis_version', iisVersion);
              core.setOutput('iis_sha', tagRef.data.object.sha);
            }
            
            core.setOutput('iotedge_update', iotedgeUpdate);
            core.setOutput('iis_update', iisUpdate);
            core.setOutput('needs_update', needsUpdate);
            core.setOutput('is_significant', needsUpdate);  // Any update is significant now
            
            if (!needsUpdate) {
              console.log('âœ… Already at latest versions');
            }

  update-recipes:
    name: Update recipes
    needs: check-upstream
    if: needs.check-upstream.outputs.needs_update == 'true' && needs.check-upstream.outputs.is_significant == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    container:
      image: ghcr.io/${{ github.repository_owner }}/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Update recipes
        env:
          IOTEDGE_UPDATE: ${{ needs.check-upstream.outputs.iotedge_update }}
          IOTEDGE_VERSION: ${{ needs.check-upstream.outputs.iotedge_version }}
          IOTEDGE_SHA: ${{ needs.check-upstream.outputs.iotedge_sha }}
          IIS_UPDATE: ${{ needs.check-upstream.outputs.iis_update }}
          IIS_VERSION: ${{ needs.check-upstream.outputs.iis_version }}
          IIS_SHA: ${{ needs.check-upstream.outputs.iis_sha }}
        run: |
          set -euo pipefail
          args=()
          
          # Only clean up recipes for components being updated
          if [[ "${IOTEDGE_UPDATE}" == "true" ]]; then
            echo "Cleaning up old IoT Edge recipes..."
            # iotedge and aziot-edged are both IoT Edge components
            for dir in iotedge aziot-edged; do
              find "recipes-core/${dir}" -name "*_*.bb" -type f -delete 2>/dev/null || true
              find "recipes-core/${dir}" -name "*-[0-9]*.inc" -type f -delete 2>/dev/null || true
            done
            echo "Updating IoT Edge to ${IOTEDGE_VERSION} (${IOTEDGE_SHA})"
            args+=(--iotedge-rev "${IOTEDGE_SHA}" --iotedge-version "${IOTEDGE_VERSION}")
          fi
          
          if [[ "${IIS_UPDATE}" == "true" ]]; then
            echo "Cleaning up old IIS recipes..."
            # aziotd, aziotctl, aziot-keys are IIS components
            for dir in aziotd aziotctl aziot-keys; do
              find "recipes-core/${dir}" -name "*_*.bb" -type f -delete 2>/dev/null || true
              find "recipes-core/${dir}" -name "*-[0-9]*.inc" -type f -delete 2>/dev/null || true
            done
            echo "Updating IIS to ${IIS_VERSION} (${IIS_SHA})"
            args+=(--iis-rev "${IIS_SHA}" --iis-version "${IIS_VERSION}")
          fi
          
          echo "Remaining recipe files before update:"
          find recipes-core -name "*.bb" -o -name "*.inc" | grep -v files/ | sort || true
          
          if [[ ${#args[@]} -gt 0 ]]; then
            ./scripts/update-recipes.sh "${args[@]}"
          fi
          
          echo "Recipe files after update:"
          find recipes-core -name "*.bb" -o -name "*.inc" | grep -v files/ | sort

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Update to IoT Edge ${{ needs.check-upstream.outputs.iotedge_version }}"
          commit-message: |
            Update IoT Edge recipes for ${{ needs.check-upstream.outputs.iotedge_version }}
            
            - IoT Edge daemon: ${{ needs.check-upstream.outputs.iotedge_version || 'unchanged' }}
            - IoT Identity Service: ${{ needs.check-upstream.outputs.iis_version || 'unchanged' }}
          branch: automation/upstream-update
          delete-branch: true
          labels: |
            automated
            upstream-update
          body: |
            ## Automated Upstream Update
            
            This PR was automatically created by the upstream release watcher.
            
            ### Versions
            | Component | Current | New |
            |-----------|---------|-----|
            | IoT Edge | ${{ env.CURRENT_IOTEDGE }} | ${{ needs.check-upstream.outputs.iotedge_version }} |
            | IoT Identity Service | ${{ env.CURRENT_IIS }} | ${{ needs.check-upstream.outputs.iis_version || env.CURRENT_IIS }} |
            
            ### Validation Checklist
            - [ ] CI build passes
            - [ ] QEMU validation passes
            
            ### After Merging
            Create a release by running:
            ```bash
            git pull origin main
            git tag ${{ needs.check-upstream.outputs.release_version }}
            git push origin ${{ needs.check-upstream.outputs.release_version }}
            ```
            This will trigger the [release workflow](../actions/workflows/release.yml) to build and publish packages.
            
            ### Release Notes
            - [Azure IoT Edge ${{ needs.check-upstream.outputs.release_version }}](https://github.com/Azure/azure-iotedge/releases/tag/${{ needs.check-upstream.outputs.release_version }})
