name: Watch upstream releases

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    name: Check for new releases
    runs-on: ubuntu-22.04
    outputs:
      release_version: ${{ steps.check.outputs.release_version }}  # Latest overall release (e.g., 1.5.35)
      daemon_version: ${{ steps.check.outputs.daemon_version }}    # Daemon binary version (e.g., 1.5.21)
      current_recipe: ${{ steps.check.outputs.current_recipe }}    # Current recipe version
      needs_update: ${{ steps.check.outputs.needs_update }}        # Whether recipe update is needed
      is_significant: ${{ steps.check.outputs.is_significant }}    # Whether this is a daemon update (not Docker-only)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check upstream releases
        id: check
        run: |
          # Run the check script and capture output
          output=$(./scripts/check-upstream.sh)
          
          # Parse key=value output and set as GitHub outputs
          while IFS='=' read -r key value; do
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done <<< "$output"

  update-recipes:
    name: Update recipes
    needs: check-upstream
    if: needs.check-upstream.outputs.needs_update == 'true' && needs.check-upstream.outputs.is_significant == 'true'
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    container:
      image: ghcr.io/azure/meta-iotedge-devcontainer:scarthgap
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix git permissions
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Update and validate recipes
        run: |
          ./scripts/update-recipes.sh \
            --iotedge-version "${{ needs.check-upstream.outputs.release_version }}" \
            --clean

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B automation/upstream-update
          git add -A
          git commit -m "Update IoT Edge recipes for ${{ needs.check-upstream.outputs.release_version }}

          IoT Edge daemon version: ${{ needs.check-upstream.outputs.daemon_version }}"
          git push --force origin automation/upstream-update

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          script: |
            const branch = 'automation/upstream-update';
            const base = 'main';
            const title = 'Update to IoT Edge ${{ needs.check-upstream.outputs.release_version }}';
            const body = [
              '## Automated Upstream Update',
              '',
              'This PR was automatically created by the upstream release watcher.',
              '',
              '### Versions',
              '| Component | Current | New |',
              '|-----------|---------|-----|',
              '| Release | ${{ needs.check-upstream.outputs.current_recipe }} | ${{ needs.check-upstream.outputs.release_version }} |',
              '| Daemon | - | ${{ needs.check-upstream.outputs.daemon_version }} |',
              '',
              '### Validation Checklist',
              '- [ ] CI build passes',
              '- [ ] QEMU validation passes',
              '',
              '### After Merging',
              'Create a release by running:',
              '```bash',
              'git pull origin main',
              'git tag ${{ needs.check-upstream.outputs.release_version }}',
              'git push origin ${{ needs.check-upstream.outputs.release_version }}',
              '```',
              'This will trigger the [release workflow](../actions/workflows/release.yml) to build and publish packages.',
              '',
              '### Release Notes',
              '- [Azure IoT Edge ${{ needs.check-upstream.outputs.release_version }}](https://github.com/Azure/azure-iotedge/releases/tag/${{ needs.check-upstream.outputs.release_version }})'
            ].join('\n');

            // Check for existing open PR from this branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: base,
              state: 'open'
            });

            if (prs.length > 0) {
              // Update existing PR
              const pr = prs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: title,
                body: body
              });
              core.info(`Updated existing PR #${pr.number}`);
            } else {
              // Create new PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: branch,
                base: base,
                title: title,
                body: body
              });
              // Add labels
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['automated', 'upstream-update']
              });
              core.info(`Created PR #${pr.number}`);
            }

  # Notify when recipes are current (daemon) but there's a newer Docker-only release
  notify-docker-only:
    name: Notify Docker-only update
    needs: check-upstream
    # Notify if: no significant update needed AND recipe is behind release version
    # This means only Docker images changed, not the daemon binaries
    if: |
      needs.check-upstream.outputs.is_significant != 'true' &&
      needs.check-upstream.outputs.current_recipe != needs.check-upstream.outputs.release_version
    runs-on: ubuntu-22.04
    permissions:
      issues: write
    steps:
      - name: Create issue for Docker-only update
        uses: actions/github-script@v7
        with:
          script: |
            const releaseVersion = '${{ needs.check-upstream.outputs.release_version }}';
            const daemonVersion = '${{ needs.check-upstream.outputs.daemon_version }}';
            const currentRecipe = '${{ needs.check-upstream.outputs.current_recipe }}';
            
            // Check if there's already an open issue for this release
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'docker-only-update'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes(releaseVersion));
            if (existingIssue) {
              console.log(`Issue already exists for ${releaseVersion}`);
              return;
            }
            
            const body = [
              'A new IoT Edge release is available, but it only contains Docker image updates.',
              '',
              `**Latest Release:** ${releaseVersion}`,
              `**Daemon Version:** ${daemonVersion} (unchanged)`,
              `**Current Recipe:** ${currentRecipe}`,
              '',
              'No recipe updates are needed since the daemon binaries haven\'t changed.',
              '',
              'This issue is for tracking purposes only. Close it once acknowledged.',
              '',
              `[View release notes](https://github.com/Azure/azure-iotedge/releases/tag/${releaseVersion})`
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `IoT Edge ${releaseVersion} released (Docker images only)`,
              labels: ['docker-only-update', 'no-action-needed'],
              body: body
            });
